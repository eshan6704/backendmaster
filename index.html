<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Stock Data Frontend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: sans-serif;
      overflow: hidden;
    }

    /* TOP BAR FIXED */
    .form-row {
      display: flex;
      align-items: center;
      width: 100%;
      height: 40px;
      background: #f5f5f5;
      border-bottom: 1px solid #ccc;
      font-size: 0.9rem;
    }

    .left {
      width: 25%;
      padding-left: 10px;
      font-weight: bold;
    }

    .center {
      width: 15%;
      text-align: center;
      font-weight: bold;
    }

    .right {
      width: 60%;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      padding-right: 10px;
    }

    input, select { padding: 3px; }
    select { width: 130px; }
    button { padding: 3px 8px; }

    /* Output IFRAME */
    #output {
      width: 100%;
      height: calc(100% - 40px);
      overflow: hidden;
    }

    #resultFrame {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Chart full screen */
    #chart {
      width: 100%;
      height: calc(100% - 40px);
      display: none;
      overflow: hidden;
      background: #fff;
    }
  </style>
</head>

<body>

  <div class="form-row">
    <div class="left">Page designed by Eshan Patel - 9730425081</div>
    <div class="center" id="clock">--/--/---- --:--</div>

    <div class="right">
      <label>Symbol <input id="symbol" value="PNB" /></label>

      <label>Type 
        <select id="reqtype">
          <option value="index">index</option>
                    
          <option value="info">info</option>
          <option value="intraday">intraday</option>
          <option value="daily" selected>daily</option>
          <option value="qresult">qresult</option>
          <option value="result">result</option>
          <option value="balance">balance</option>
          <option value="cashflow">cashflow</option>
          <option value="dividend">dividend</option>
          <option value="split">split</option>
          <option value="other">other</option>
        </select>
      </label>

      <button id="sendBtn">Fetch</button>
      <button id="toggleBtn">Show Chart</button>
    </div>
  </div>

  <!-- IFREAME OUTPUT -->
  <div id="output">
    <iframe id="resultFrame"></iframe>
  </div>

  <!-- FULL SCREEN CHART -->
  <div id="chart"></div>

<script type="module">
  import { client } from "https://esm.run/@gradio/client";

  const SPACE_URL = "https://eshan6704-backendmaster.hf.space";
  let gradioClient;

  async function init() {
    gradioClient = await client(SPACE_URL);
    startClock();
  }

  async function fetchData() {
    const symbol = document.getElementById("symbol").value;
    const reqtype = document.getElementById("reqtype").value;

    try {
      const result = await gradioClient.predict("/fetch_data", [symbol, reqtype]);
      const htmlContent = result.data[0];

      const doc = resultFrame.contentDocument;
      doc.open();
      doc.write(htmlContent);
      doc.close();

    } catch (err) {
      const doc = resultFrame.contentDocument;
      doc.open();
      doc.write("<h1>Error</h1><p>" + err.message + "</p>");
      doc.close();
    }
  }

  /* Extract table, convert to data, build Plotly chart */
  function showPlotlyChart() {
    const doc = resultFrame.contentDocument;
    const table = doc.querySelector("table");

    if (!table) {
      chart.innerHTML = "<h2>No Table Found in Output</h2>";
      return;
    }

    const rows = [...table.querySelectorAll("tr")].map(r =>
      [...r.querySelectorAll("th,td")].map(c => c.textContent.trim())
    );

    const headers = rows[0];
    const data = rows.slice(1);

    const idxDate = headers.indexOf("Date");
    const idxOpen = headers.indexOf("Open");
    const idxHigh = headers.indexOf("High");
    const idxLow  = headers.indexOf("Low");
    const idxClose = headers.indexOf("Close");
    const idxVolume = headers.indexOf("Volume");

    const dates = data.map(r => r[idxDate]);
    const open = data.map(r => Number(r[idxOpen]));
    const high = data.map(r => Number(r[idxHigh]));
    const low  = data.map(r => Number(r[idxLow]));
    const close = data.map(r => Number(r[idxClose]));
    const volume = data.map(r => Number(r[idxVolume]));

    const candle = {
      x: dates, open, high, low, close,
      type: "candlestick",
      name: "Price"
    };

    const vol = {
      x: dates,
      y: volume,
      type: "bar",
      name: "Volume",
      yaxis: "y2",
      opacity: 0.4
    };

    const layout = {
      dragmode: "zoom",
      margin: { t: 30, b: 30 },
      xaxis: { rangeslider: { visible: false } },
      yaxis2: { overlaying: "y", side: "right" },
      height: document.getElementById("chart").clientHeight
    };

    Plotly.newPlot("chart", [candle, vol], layout);
  }

  /* VIEW TOGGLE */
  function toggleView() {
    if (output.style.display !== "none") {
      output.style.display = "none";
      chart.style.display = "block";
      toggleBtn.textContent = "Show Output";
      showPlotlyChart();
    } else {
      chart.style.display = "none";
      output.style.display = "block";
      toggleBtn.textContent = "Show Chart";
    }
  }

  /* CLOCK */
  function startClock() {
    function updateClock() {
      const now = new Date();
      const d = String(now.getDate()).padStart(2, '0');
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const y = now.getFullYear();
      const h = String(now.getHours()).padStart(2, '0');
      const mi = String(now.getMinutes()).padStart(2, '0');
      clock.textContent = `${d}/${m}/${y} ${h}:${mi}`;
    }
    updateClock();
    setInterval(updateClock, 1000);
  }

  window.addEventListener("DOMContentLoaded", () => {
    sendBtn.addEventListener("click", fetchData);
    toggleBtn.addEventListener("click", toggleView);
    init();
  });
</script>

</body>
</html>
